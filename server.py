# connection
import websockets
import asyncio

# data structures
import json

# handlers
import scripts.request_handler as req


async def handler(websocket):
    message = await websocket.recv()
    # message = json.dumps("{\"operation\": \"addApparat\", \"session_hash\": \"47\", \"apparat_name\": \"P320-OO\" }")
    request = dict(json.loads(message))
    return_json = req.request_handler(request)
    print(return_json)
    await websocket.send(json.dumps(return_json, ensure_ascii=False))


def test_handler():
    message = json.loads("{\"operation\": \"loadElements\", \"session_hash\": [\"47\", \"5\"], \"element_id\": 1,"
                         "\"element\": {\"type\": \"rotator\", \"src\": \"data:image/png;base64,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\"}}")
    answer_json = req.request_handler(message)
    print(answer_json)
    return answer_json


async def main():
    print("SERVER ON")
    # test_handler()
    async with websockets.serve(handler, "", 8083, max_size=10_000_000):
        await asyncio.Future()

if __name__ == "__main__":
    asyncio.run(main())
